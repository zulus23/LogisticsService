@*
* This template takes a single argument, a String containing a
* message to display.
*@

@import com.fasterxml.jackson.databind.JsonNode
@(message: String)(implicit webJarAssets: WebJarAssets,paramReportSelectForm:Form[ParamReportSelect],select:ParamReportSelect)


@main("Точность открытия заказов") {
 @*   <div class="container-fluid">*@
        <div id="vertical">
        <div>
            <div class="col-md-offset-4 col-md-4">
                <h2 class="text-primary text-center">Точность открытия заказов</h2>
            </div>


            <div id="graph" class="col-md-offset-1 col-md-10" >
                <div class="demo-section k-content wide">
                    <div id="chart1"></div>
                </div>
            </div>
        </div>
        <div  id="t1" class="col-md-12" >
            <div id="gridTest"></div>
        </div>
        </div>
        <script>
              /* var dataall = [];

               for(order <- listOrder) {
               var order = {}
               order["OrderNumber"] = 'order.getOrderNumber()';
               order["OrderLine"] ='order.getOrderLine()';
               order["Manager"] ='order.getManager()';
               order["Customer"] ='order.getCustomer()';
               dataall.push(order);
               }
*/             $("#vertical").kendoSplitter({
                  orientation: "vertical",
                  panes: [
                      { collapsible: true, size: "60px" },
                      { collapsible: false },
                      { collapsible: false, resizable: false, size: "15%" }
                  ]
              });


               var dataSourceDB = new kendo.data.DataSource({
                   transport: {
                       read: function(options) {
                           $.ajax({
                               type: "GET",
                               url: "api/listorder",
                               contentType: "application/json; charset=utf-8",
                               dataType: 'json',
                               data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                               success: function(data) {
                                   options.success(data);
                               }
                           });
                       }
                   },
                 //  pageSize:20,
                   aggregate:[
                       {field:"caclStatus",aggregate:"count"},
                       {field:"customer", aggregate:"count"},
                       {field:"monthShip", aggregate:"count"}
                   ]

                   ,change: function(e) {
                       var data = this.data();
                       console.log(data.length); // displays "77"
                   }

               });

              var dataSourceGrapth = new kendo.data.DataSource({
                  transport: {
                      read: function(options) {
                          $.ajax({
                              type: "GET",
                              url: "api/grapth",
                              contentType: "application/json; charset=utf-8",
                              dataType: 'json',
                              data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                              success: function(data) {
                                  options.success(data);
                              }
                          });
                      }
                  },
                  pageSize:20
              });




              $("#gridTest").kendoGrid({
                   toolbar: ["excel"],
                   excel: {
                       allPages: true
                   },

                    dataSource: dataSourceDB,
                        schema: {
                            model: {
                                id:"id",

                                fields: {
                                    /* site:{type:"string"},*/
                                    orderNumber: { type: "string" },
                                    orderLine: { type: "number" },
                                    manager: { type: "string" },
                                    customer: { type: "string" },
                                    itemDescription:{type:"string"},
                                    monthShip:{type:"string"},
                                    dateCreateOrderFormat:{type:"string"},
                                    dateBeginProductionFormat:{type:"string"},
                                    deviation:{type:"number"},
                                    caclStatus:{type:"string"}
                                }
                            }
                        }                    ,
                    height: '100%',
                    groupable: true,

                   /*    rowTemplate: "<tr>" + "#= getGridGroupCells('gridTest') #" + "<td>...</td><td>...</td><td>...</td></tr>",
                       altRowTemplate: "<tr class='k-alt'>" +                  "#= getGridGroupCells('gridTest') #" +              "<td>...</td><td>...</td><td>...</td></tr>",*/
                    sortable: true,
                    filterable: true,
                   /* pageable: {
                         pageSizes: true
                    },*/
                    columns: [
                        { field: "orderNumber",title:"№ Заказа", width: "70px"},
                        { field: "orderLine", title: "№ Строки",  width: "30px" },
                        { field: "manager", title: "Менеджер", width: "70px" ,aggregates: ["count"],
                            groupHeaderTemplate: "Состояние: #=value# : (#= calcAll(data)#)"},
                        { field: "customer", title: "Клиент",width: "130px" ,aggregates: ["count"],
                            groupHeaderTemplate: "Состояние: #=value# : (#= calcAll(data)#)"},
                        { field: "itemDescription", title: "Наименование заказа",width: "130px" },
                        { field: "monthShip", title: "Месяц отгрузки",width: "50px",aggregates: ["count"],
                                 groupHeaderTemplate: "Месяц отгрузки: #=value# : (#= calcAll(data)#)"    },
                        { field: "dateCreateOrderFormat", title: "Дата открытия заказа",width: "150px"},
                        { field: "dateBeginProductionFormat", title: "Дата начала производства",width: "150px" },
                        { field: "deviation", title: "Отклонение",width: "130px" },

                        { field: "caclStatus", title: "Состояние",width: "130px" ,aggregates: ["count"],
                                    groupHeaderTemplate: "Состояние: #=value# : (#= calcAll(data)#)" }

                    ]
                });
              function calcAll(field,value){
                  console.log(value);

                  var result = 0;
                  dataView =  dataSourceDB.view();
                  for (var i = 0; i < dataView.length; i++){
                    // result =  result +selectCount(dataView[i],field,value);
                     console.log(loop(dataView[i]));
                  }

                  return result;
              }

              function selectCount(object_,field,value){
                  if(object_.field === field  ){
                     return object_.aggregates.caclStatus.count;
                  }
                 // if(object_.hasSubgroups){ for (k in object_.items){ return selectCount(object_.items[k],field)} }
/*
                  if(object_.field === field){ return object_.aggregates.caclStatus.count} else{
                       if(object_.hasSubgroups){ }




                   }
*/
                  return 0;
              }
              function loop(data) {
                  return data.hasSubgroups ? loop(data.items) : data.items;
              }

              window.getGridGroupCells = function(id) {
                  var cnt = $("#" + id).data("kendoGrid").dataSource.group().length,
                          result = "";

                  for (var j = 0; j < cnt; j++) {
                      result += "<td class='k-group-cell'>&nbsp;</td>";
                  }

                  return result;
              }


              $("#chart1").kendoChart({
                  dataSource: dataSourceGrapth,
                  series: [{


                      field: "series"

                  }],
                  categoryAxis: {
                      field: "categoryAxis"
                  }
              });


        </script>

}