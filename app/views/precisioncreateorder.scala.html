@*
* This template takes a single argument, a String containing a
* message to display.
*@

@import com.fasterxml.jackson.databind.JsonNode
@(message: String)(implicit webJarAssets: WebJarAssets,paramReportSelectForm:Form[ParamReportSelect],select:ParamReportSelect)


@main("Точность открытия заказов") {
 @*   <div class="container-fluid">*@
        <div id="vertical">
        <div>
            <div class="col-md-offset-4 col-md-4">
                <h2 class="text-primary text-center">Точность открытия заказов</h2>
            </div>
            <div id="loading">
            </div>

            <div id="graph" class="col-md-offset-1 col-md-10" >
                <div class="demo-section k-content wide">
                    <div id="chart1"></div>
                </div>
            </div>
        </div>
        <div  id="t1" class="col-md-12" >
            <div id="gridTest"></div>
        </div>
        </div>
        <script>
              /* var dataall = [];

               for(order <- listOrder) {
               var order = {}
               order["OrderNumber"] = 'order.getOrderNumber()';
               order["OrderLine"] ='order.getOrderLine()';
               order["Manager"] ='order.getManager()';
               order["Customer"] ='order.getCustomer()';
               dataall.push(order);
               }
*/             $("#vertical").kendoSplitter({
                  orientation: "vertical",
                  panes: [
                      { collapsible: false, size: "50%" },
                      { collapsible: false },
                      { collapsible: false, resizable: false, size: "35%" }
                  ]
              });

              createDefaultGraph();
               var dataSourceDB = new kendo.data.DataSource({
                   serverAggregates: true,
                   transport: {
                       read: function(options) {
                           $.ajax({
                               type: "GET",
                               url: "api/listorder",
                               contentType: "application/json; charset=utf-8",
                               dataType: 'json',
                               data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                               success: function(data) {
                                   options.success(data);
                               }
                           });
                       }
                   },
                   pageSize:20,
                   schema: {
                       model: {
                           id:"id",

                           fields: {
                               /* site:{type:"string"},*/
                               orderNumber: { type: "string" },
                               orderLine: { type: "number" },
                               manager: { type: "string" },
                               customer: { type: "string" },
                               itemDescription:{type:"string"},
                               monthShip:{type:"string"},
                               dateCreateOrderFormat:{type:"string"},
                               dateBeginProductionFormat:{type:"string"},
                               deviation:{type:"number"},
                               reasonDeviation:{type:"string"},
                               caclStatus:{type:"string"},
                               monthActualShip:{type:"date"},
                               nornalizeGroupDate:{type:"date"}
                           }
                       }
                   },
                   //  pageSize:20,
                   aggregate:[
                       {field:"caclStatus",aggregate:"count"},
                       {field:"customer", aggregate:"count"},
                       {field:"monthShip", aggregate:"count"}
                   ],
                   change: function(e) {

                       var query = new kendo.data.Query(dataSourceDB.data());
                       var filters = dataSourceDB.filter();
                       filteredData = query.filter(filters).data;

                       allDataCount = filteredData.length;

                       if(dataSourceDB.group().length > 0 ){
                        createGraph(dataSourceDB.group()[0].field);
                       } else {
                           createDefaultGraph();
                       }
                       /*var chart = $("#chart1").data("kendoChart");
                       chart.dataSource.filter(dataSourceDB.filter());*/
                   }


               });

              var dataSourceGrapth = new kendo.data.DataSource({
                  transport: {
                      read: function(options) {
                          $.ajax({
                              type: "GET",
                              url: "api/grapth",
                              contentType: "application/json; charset=utf-8",
                              dataType: 'json',
                              data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise',groupField:''},
                              beforeSend: function() { $('#loading').show(); },
                              success: function(data) {

                                  $('#loading').hide();
                                  options.success(data);
                              }
                          });
                      }
                  },
                  sort: [
                      { "field": "categoryAxis", "dir": "asc" }
                  ],
              });

              var names = _.sortBy(_.uniq(_.pluck(dataSourceDB.data(), "customer")), function(n) { return n; });

              function createMultiSelect(element) {
                  element.removeAttr("data-bind");

                  element.kendoMultiSelect({
                      dataSource: _.sortBy(_.uniq(_.pluck(dataSourceDB.data(), "customer")), function(n) { return n; }),
                      change: function(e) {
                          var filter = { logic: "or", filters: [] };
                          var values = this.value();
                          $.each(values, function(i, v) {
                              filter.filters.push({field: "customer", operator: "eq", value: v });
                          });

                          dataSourceDB.filter(filter);
                      }
                  });
              }

              var headerFormat = {"class": "table-header-cell",
                                  style: " overflow: visible; white-space: normal; text-align: center; vertical-align:top; font-size: 10px"};
              var columnFormat  = { "class": "table-cell",         style: "text-align: center; font-size: 11px" };

              $("#gridTest").kendoGrid({
                   toolbar: ["excel"],
                   excel: {
                       allPages: true
                   },

                    dataSource: dataSourceDB,
                    height: '100%',
                    groupable: true,
                    sortable: true,
                    filterable: true,
                    //resizable:true,
                    pageable: {
                         pageSizes: true
                    },
                    columns: [
                        { field: "orderNumber",title:"№ Заказа", width: "70px",headerAttributes: headerFormat,attributes: columnFormat,groupable: false },
                        { field: "orderLine", title: "№ Строки",  width: "60px",headerAttributes: headerFormat,attributes: columnFormat,filterable: false,groupable: false   },
                        { field: "manager", title: "Менеджер", width: "80px",headerAttributes: headerFormat ,attributes: columnFormat, aggregates: ["count"],
                            groupHeaderTemplate: "Менеджер: #=value#: #=count# : (#=  Math.round((count/calcAll(data,field,value))*100)#%): Count : #=count#"},
                        { field: "customer", title: "Клиент",width: "180px" ,aggregates: ["count"],headerAttributes: headerFormat,attributes: columnFormat,
                           filterable: {
                                ui : createMultiSelect,
                                extra: false
                            },
                            /*groupHeaderTemplate: "Клиент: #=value# : #=count#: (#= Math.round((count/calcAll(data,field,value))*100)#%)"*/
                            groupHeaderTemplate: "Клиент: #=value# : #=count#: (#= calcAll(data,field,value,count)#)"
                            //groupHeaderTemplate: "Клиент: #=value# : #=count#"
                        },
                        { field: "itemDescription", title: "Наименование заказа",width: "130px" ,headerAttributes: headerFormat,attributes: columnFormat,filterable: false,groupable: false },
                        { field: "monthShip", title: "Месяц отгрузки",width: "50px",headerAttributes: headerFormat ,attributes: columnFormat,groupable: false, aggregates: ["count"],
                                 groupHeaderTemplate: "Месяц отгрузки: #=value# : (#= calcAll(data,field,value)#)"
                            //groupHeaderTemplate: "Месяц отгрузки: #=value# : (#= count#)"
                        },
                        { field: "dateCreateOrderFormat", title: "Дата открытия заказа",width: "80px",
                            headerAttributes: headerFormat,attributes: columnFormat,filterable: false,groupable: false
                        },
                        { field: "dateBeginProductionFormat", title: "Дата начала производства",width: "80px",
                            headerAttributes: headerFormat,attributes: columnFormat,filterable: false,groupable: false
                        },
                        { field: "deviation", title: "Отклонение",width: "65px",headerAttributes: headerFormat,attributes: columnFormat,groupable: false },
                        { field: "reasonDeviation", title: "Причина отклонений",width: "65px",headerAttributes: headerFormat,attributes: columnFormat,groupable: true,aggregates: ["count"],
                            groupHeaderTemplate: "Причина отклонений: #=value#: #=count# : (#= calcAll(data,field,value,count)#)"},

                        { field: "caclStatus", title: "Состояние",width: "80px" ,aggregates: ["count"],headerAttributes: headerFormat,attributes: columnFormat,
                          //groupHeaderTemplate: "Состояние: #=value#: #=count# : (#= Math.round((count/calcAll(data,field,value))*100)#%)"
                           groupHeaderTemplate: "Состояние: #=value#: #=count# : (#= calcAll(data,field,value,count)#)"
                            //groupHeaderTemplate: "Состояние: #=value#: #=count# "
                        }

                    ]
                });

              var tree = [];

              var level1 = [{}]
              var prevLevelValue = [];
              var prevLevelCount = [];
              var fieldObject = {};
              function calcAll(data,field,value,count_) {
                  //tree[-1] = {prevLevel : -1,level: -1,value:"",countAll:allDataCount/*dataSourceDB.total()*/};
                  //prevLevelCount[-1] = allDataCount;/*dataSourceDB.total();*/
                  prevLevelValue[-1] = "";
                  var levelTree = indexGroup(dataSourceDB.group(), field);
                  prevLevelValue[levelTree] = data.value;
                  //prevLevelCount[levelTree] = data.count;
                  if (!findObject(level1, levelTree, data.value, prevLevelValue[levelTree - 1])) {
                      level1.push({
                          prevLevel: levelTree - 1,
                          level: levelTree,
                          value: data.value,
                          prevValue: prevLevelValue[levelTree - 1]
                          /*countAll:data.count, prevCount:prevLevelCount[levelTree - 1]*/
                      });
                  }
                  //  return findCountPrevObject(level1,data.value,prevLevelValue[levelTree-1]);


                  var allCount = 0;

                  function getPrecisionCustomer(field, value, isPrecision) {
                      var fieldObjectLocal = {};
                      fieldObjectLocal["customer"] = value;
                      var tempAll = _.groupBy(_.pluck(_.where(filteredData, fieldObjectLocal), "caclStatus"), function (n) {
                          return "count"
                      });
                      tempAll = _.isUndefined(tempAll.count) ? 1 : tempAll.count.length
                      fieldObjectLocal["caclStatus"] = "Без отклонений";
                      var temp = _.groupBy(_.pluck(_.where(filteredData, fieldObjectLocal), "caclStatus"), function (n) {
                          return "count"
                      });
                      temp = _.isUndefined(temp.count) ? 1 : temp.count.length;
                      return isPrecision ? Math.round((temp / tempAll) * 100) + " %" : Math.round((1 - (temp / tempAll)) * 100) + " %";
                  }

                      if (indexGroup(dataSourceDB.group(), field) === 0) {
                          fieldObject = {};
                          // fieldObject[field]=value;
                          if (field === "customer") {
                              return getPrecisionCustomer(field, value, true);
                          } else {
                              allCount = _.groupBy(_.pluck(_.where(filteredData, fieldObject), "caclStatus"), function (n) {
                                  return "count"
                              });
                              allCount = _.isUndefined(allCount.count) ? 1 : allCount.count.length;
                          }

                      }
                      if (indexGroup(dataSourceDB.group(), field) === 1) {

                          fieldObject ={};
                          //   if(field === "customer"){   return  getPrecisionCustomer(field,value);
                          var prevValue = findPrevObject(level1, data.value, prevLevelValue[levelTree - 1]);
                          if (field === "customer") {
                              return getPrecisionCustomer(field, value, true);//fieldObject[dataSourceDB.group()[0].field] = prevValue.prevValue;
                          } else { fieldObject[dataSourceDB.group()[0].field] = prevLevelValue[0];/*fieldObject[field] = prevValue.value; */}
                           var tempAll = _.groupBy(_.pluck(_.where(filteredData, fieldObject), field), function (n) {
                                    return "count"
                          });
                          allCount = _.isUndefined(tempAll.count) ? 1 : tempAll.count.length;
                      }
                      if (indexGroup(dataSourceDB.group(), field) === 2) {
                          fieldObject ={};

                          fieldObject[dataSourceDB.group()[0].field] = prevLevelValue[0];
                          fieldObject[dataSourceDB.group()[1].field] = prevLevelValue[1];

                          var prevValue = findPrevObject(level1, data.value, prevLevelValue[levelTree - 1]);
                          var tempAll = _.groupBy(_.pluck(_.where(filteredData, fieldObject), field), function (n) {
                              return "count"
                          });
                          allCount = _.isUndefined(tempAll.count) ? 1 : tempAll.count.length;
                      }

                      return (allCount <= count_ ) ? Math.round((allCount / count_) * 100) + " %" : Math.round((count_ / allCount) * 100) + " %";
                  }

              function indexGroup(dataGroup, findElement){
                  for(var i = 0, len = dataGroup.length;  i < len; i++){
                      if(dataGroup[i].field === findElement){ return i;}
                  }
                  return -1;
              }
              function findObject(data,currentLevel,value, prevValue){
                  for(var i = 0, len = data.length;  i < len; i++){
                     if(data[i].level === currentLevel && data[i].value === value && data[i].prevValue === prevValue){
                         return true;
                     }
                  }
                  return false;
              }
              function findCountPrevObject(data,value,prevValue){
                  for(var i = 0, len = data.length;  i < len; i++){
                      if(data[i].value === value && data[i].prevValue === prevValue){
                          return data[i].prevCount;
                      }
                  }
                  return -1;
              }

              function findPrevObject(data,value,prevValue){
                  for(var i = 0, len = data.length;  i < len; i++){
                      if(data[i].value === value && data[i].prevValue === prevValue){
                          return data[i];
                      }
                  }
                  return {};
              }

              function filterCount(){
                  var query = new kendo.data.Query(dataSourceDB.data());
                  var filters = dataSourceDB.filter();
                  var filteredData = query.filter(filters).data;
              }

              function labelTemplate(e) {
                  var ds = dataSourceDB;
                  var date = new Date(e.value);
                  var label = (date.getMonth()+1) + '-'+ date.getFullYear();


                  return label;
              }

            /*  function localDataForDeviation(){
                  var data = [];
                  var query = new kendo.data.Query(dataSourceDB.data());
                  var filters = dataSourceDB.filter();
                  var filteredData = query.filter(filters).data;
                  var uniqDate =  _.uniq(filteredData,false,function(p){ return p.monthShip} ).map(function(e){return e.monthShip});
                  _.each(uniqDate,function (e) {
                                                  var all = _.where(filteredData,{monthShip:e}).length;
                                                  var countPre = _.where(filteredData,{monthShip:e,caclStatus:"Без отклонений"}).length;
                                                  var _procent = Math.round((countPre/all)*100);
                                                  var myDate = moment(e, "MMM-YYYY","ru");
                                                  data.push({deviation:"Без отклонений",monthActualShip:myDate,procent:_procent });
                                                 // data.push({deviation:"C отклонениями",monthActualShip:myDate,procent:100-_procent });
                                                 });
                  return data;
              }*/
              function createGraph(groupField){

                  var _datasource =  createLocalDatasourceForgraph(groupField);
                  /*datasource_.filter(dataSourceDB.filter());
                  var visibleLegend = !!dataSourceDB.filter()? (dataSourceDB.filter().filters.length > 0 ? true : false): false ;*/
                  $("#chart1").kendoChart({
                      dataSource: _datasource,
                      legend: {
                          visible: true,
                          position:"top"
                      },
                      series: [/*{
                          type: "column",
                          field: "procent",

                      },*/{
                          type: "column",
                          field: "procent",
                          tooltip: {
                              visible: true,
                              template: "#= kendo.format('{0}%', value) #"
                          }
                      },{
                          type: "line",
                          field: "procent",
                          tooltip: {
                              visible: true,
                              template: "#= kendo.format('{0}%', value) #"
                          },
                          visibleInLegend: false

                      }],

                      valueAxis: {

                          labels: {

                              min:0,
                              max:100,
                              format: "{0}%"
                          }
                      },
                     categoryAxis: {

                          baseUnit:"months",
                          field: "monthActualShip",
                          labels: {

                              template: "#= kendo.format('{0:MMMM-yyyy}', new Date(value)) #"

                          }
                      }/*,
                      tooltip: {
                          visible: true,
                          template: "#:value#%"
                      }*/
                  });
              }
              function createDefaultGraph(){
                  $("#chart1").kendoChart({
                      dataSource: dataSourceGrapth,
                      legend: {
                          visible: false
                      },
                      series: [{
                          type: "column",
                          field: "procent"


                      },{
                          type: "line",
                          field: "procent"


                      }],

                      valueAxis: {

                          labels: {

                              min:0,
                              max:100,
                              format: "{0}%",
                              skip: 2,
                              step: 2
                          }
                      },
                      categoryAxis: {

                          field: "monthActualShip",
                          labels: {

                              template: "#= kendo.format('{0:MMMM-yyyy}', new Date(value)) #"

                          }
                      },
                      tooltip: {
                          visible: true,
                          template: "#= kendo.format('{0}%', value) #"
                      }
                  });
              }
              function createDatasourceForgraph(groupField){
                  /*var str = Object.keys(dataSourceDB.filter().filters).map(function(key){
                      return encodeURIComponent(key) + '=' + encodeURIComponent(obj[key]);
                  }).join('&');*/

                  var str = dataSourceDB.filter().filters.map(function(obj){return encodeURIComponent(obj.field)+'='+encodeURIComponent(obj.value)}).join('&');

                  var datasource =
                   new kendo.data.DataSource({
                  transport: {
                      read: function(options) {
                          $.ajax({
                              type: "GET",
                              url: "api/grapth",
                              contentType: "application/json; charset=utf-8",
                              dataType: 'json',
                              data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise',groupField:"'"+groupField+"'"},
                              beforeSend: function() { $('#loading').show(); },
                              success: function(data) {

                                  $('#loading').hide();
                                  options.success(data);
                              }
                          });
                      }
                  },
                  group: {
                           field: groupField
                       },
                  sort: [
                      { "field": "categoryAxis", "dir": "asc" }
                  ]
              });
                  return datasource;}
              function createLocalDatasourceForgraph(groupField){

                  if(groupField === 'customer') {var mydata =  graphUtils.localDataForCustomer(dataSourceDB);};
                  if(groupField === 'caclStatus') {var mydata =  graphUtils.localDataForDeviation(dataSourceDB);};
                  if(groupField === 'reasonDeviation') {var mydata =  graphUtils.localDataForReasonDeviation(dataSourceDB);};
                  //var mydata =  graphUtils.localDataForDeviation(dataSourceDB);
                  var datasource =
                          new kendo.data.DataSource({
                              data:mydata,
                              group: {
                                  field: "deviation"
                              },
                              sort: [
                                  { "field": "monthActualShip", "dir": "asc" }
                              ]
                          });
                  return datasource;}
        </script>
}
}