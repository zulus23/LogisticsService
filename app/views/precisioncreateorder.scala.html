@*
* This template takes a single argument, a String containing a
* message to display.
*@

@import com.fasterxml.jackson.databind.JsonNode
@(message: String)(implicit webJarAssets: WebJarAssets,paramReportSelectForm:Form[ParamReportSelect],select:ParamReportSelect)


@main("Точность открытия заказов") {
 @*   <div class="container-fluid">*@
        <div id="vertical">
        <div>
            <div class="col-md-offset-4 col-md-4">
                <h2 class="text-primary text-center">Точность открытия заказов</h2>
            </div>
            <div id="loading">
            </div>

            <div id="graph" class="col-md-offset-1 col-md-10" >
                <div class="demo-section k-content wide">
                    <div id="chart1"></div>
                </div>
            </div>
        </div>
        <div  id="t1" class="col-md-12" >
            <div id="gridTest"></div>
        </div>
        </div>
        <script>
              /* var dataall = [];

               for(order <- listOrder) {
               var order = {}
               order["OrderNumber"] = 'order.getOrderNumber()';
               order["OrderLine"] ='order.getOrderLine()';
               order["Manager"] ='order.getManager()';
               order["Customer"] ='order.getCustomer()';
               dataall.push(order);
               }
*/             $("#vertical").kendoSplitter({
                  orientation: "vertical",
                  panes: [
                      { collapsible: false, size: "50%" },
                      { collapsible: false },
                      { collapsible: false, resizable: false, size: "35%" }
                  ]
              });


               var dataSourceDB = new kendo.data.DataSource({
                   serverAggregates: true,
                   transport: {
                       read: function(options) {
                           $.ajax({
                               type: "GET",
                               url: "api/listorder",
                               contentType: "application/json; charset=utf-8",
                               dataType: 'json',
                               data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                               success: function(data) {
                                   options.success(data);
                               }
                           });
                       }
                   },
                   pageSize:20,
                   schema: {
                       model: {
                           id:"id",

                           fields: {
                               /* site:{type:"string"},*/
                               orderNumber: { type: "string" },
                               orderLine: { type: "number" },
                               manager: { type: "string" },
                               customer: { type: "string" },
                               itemDescription:{type:"string"},
                               monthShip:{type:"string"},
                               dateCreateOrderFormat:{type:"string"},
                               dateBeginProductionFormat:{type:"string"},
                               deviation:{type:"number"},
                               caclStatus:{type:"string"},
                               monthActualShip:{type:"date"}
                           }
                       }
                   },
                   //  pageSize:20,
                   aggregate:[
                       {field:"caclStatus",aggregate:"count"},
                       {field:"customer", aggregate:"count"},
                       {field:"monthShip", aggregate:"count"}
                   ],
                   change: function(e) {

                       var query = new kendo.data.Query(dataSourceDB.data());
                       var filters = dataSourceDB.filter();
                       var filteredData = query.filter(filters).data;
                       allDataCount = filteredData.length;

                       createGraph();
                   }


               });

              var dataSourceGrapth = new kendo.data.DataSource({
                  transport: {
                      read: function(options) {
                          $.ajax({
                              type: "GET",
                              url: "api/grapth",
                              contentType: "application/json; charset=utf-8",
                              dataType: 'json',
                              data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                              beforeSend: function() { $('#loading').show(); },
                              success: function(data) {

                                  $('#loading').hide();
                                  options.success(data);
                              }
                          });
                      }
                  },
                  sort: [
                      { "field": "categoryAxis", "dir": "asc" }
                  ],
              });




              $("#gridTest").kendoGrid({
                   toolbar: ["excel"],
                   excel: {
                       allPages: true
                   },

                    dataSource: dataSourceDB
                       /* schema: {
                            model: {
                                id:"id",

                                fields: {
                                    /!* site:{type:"string"},*!/
                                    orderNumber: { type: "string" },
                                    orderLine: { type: "number" },
                                    manager: { type: "string" },
                                    customer: { type: "string" },
                                    itemDescription:{type:"string"},
                                    monthShip:{type:"string"},
                                    dateCreateOrderFormat:{type:"string"},
                                    dateBeginProductionFormat:{type:"string"},
                                    deviation:{type:"number"},
                                    caclStatus:{type:"string"}
                                }
                            }
                        }      */              ,
                    height: '100%',
                    groupable: true,

                   /*    rowTemplate: "<tr>" + "#= getGridGroupCells('gridTest') #" + "<td>...</td><td>...</td><td>...</td></tr>",
                       altRowTemplate: "<tr class='k-alt'>" +                  "#= getGridGroupCells('gridTest') #" +              "<td>...</td><td>...</td><td>...</td></tr>",*/
                    sortable: true,
                    filterable: true,
                    pageable: {
                         pageSizes: true
                    },
                    columns: [
                        { field: "orderNumber",title:"№ Заказа", width: "70px"},
                        { field: "orderLine", title: "№ Строки",  width: "30px" },
                        { field: "manager", title: "Менеджер", width: "70px" ,aggregates: ["count"],
                            groupHeaderTemplate: "Менеджер: #=value#: #=count# : (#=  Math.round((count/calcAll(data,field,value))*100)#%): Count : #=count#"},
                        { field: "customer", title: "Клиент",width: "130px" ,aggregates: ["count"],
                            groupHeaderTemplate: "Клиент: #=value# : #=count#: (#= Math.round((count/calcAll(data,field,value))*100)#%)"},
                        { field: "itemDescription", title: "Наименование заказа",width: "130px" },
                        { field: "monthShip", title: "Месяц отгрузки",width: "50px",aggregates: ["count"],
                                 groupHeaderTemplate: "Месяц отгрузки: #=value# : (#= calcAll(data,field,value)#)"    },
                        { field: "dateCreateOrderFormat", title: "Дата открытия заказа",width: "150px"},
                        { field: "dateBeginProductionFormat", title: "Дата начала производства",width: "150px" },
                        { field: "deviation", title: "Отклонение",width: "130px" },

                        { field: "caclStatus", title: "Состояние",width: "130px" ,aggregates: ["count"],
                                    groupHeaderTemplate: "Состояние: #=value#: #=count# : (#= Math.round((count/calcAll(data,field,value))*100)#%)" }

                    ]
                });

              var tree = [];

              var level1 = [{}]
              var prevLevelValue = [];
              var prevLevelCount = [];
              function calcAll(data,field,value){
                  tree[-1] = {prevLevel : -1,level: -1,value:"",countAll:allDataCount/*dataSourceDB.total()*/};
                  prevLevelCount[-1] = allDataCount;/*dataSourceDB.total();*/
                  prevLevelValue[-1] = "";
                  var levelTree = indexGroup(dataSourceDB.group(),field);
                  prevLevelValue[levelTree] = data.value;
                  prevLevelCount[levelTree] = data.count;
                  if(!findObject(level1,levelTree,data.value,prevLevelValue[levelTree-1])){
                     level1.push({prevLevel : levelTree - 1,level: levelTree,value:data.value, prevValue:prevLevelValue[levelTree - 1],
                                  countAll:data.count, prevCount:prevLevelCount[levelTree - 1]});
                  }
                  return findCountPrevObject(level1,data.value,prevLevelValue[levelTree-1]);
              }

              function indexGroup(dataGroup, findElement){
                  for(var i = 0, len = dataGroup.length;  i < len; i++){
                      if(dataGroup[i].field === findElement){ return i;}
                  }
                  return -1;
              }
              function findObject(data,currentLevel,value, prevValue){
                  for(var i = 0, len = data.length;  i < len; i++){
                     if(data[i].level === currentLevel && data[i].value === value && data[i].prevValue === prevValue){
                         return true;
                     }
                  }
                  return false;
              }
              function findCountPrevObject(data,value,prevValue){
                  for(var i = 0, len = data.length;  i < len; i++){
                      if(data[i].value === value && data[i].prevValue === prevValue){
                          return data[i].prevCount;
                      }
                  }
                  return -1;
              }


              $("#chart1").kendoChart({
                  dataSource: dataSourceDB,
                  series: [{
                     aggregate: calcProcent,
                      type: "column",
                      field: "caclStatus",
                      categoryField:"monthActualShip"

                  },{aggregate: "count",type:"column",field:"manager",categoryField:"monthActualShip"}],
                  valueAxis: {

                      labels: {
                          format: "{0}%",
                          skip: 2,
                          step: 2
                      }
                  },
                  categoryAxis: {

                      baseUnit:"months",
                      field: "monthActualShip",
                      labels: {

                          format: "MMMM-yyyy"
                         /* template: labelTemplate*/
                      }
                  }
              });
              function labelTemplate(e) {
                  var ds = dataSourceDB;
                  var date = new Date(e.value);
                  var label = (date.getMonth()+1) + '-'+ date.getFullYear();


                  return label;
              }
              function calcProcent(values, series, dataItems, category){
                  console.log("======================"); return 80;
              }

              function createGraph(){
                  var chart = $("#chart1").data("kendoChart");
                  var series = chart.options.series;
                /*  var copyS = deepcopy(series[0]);*/

                /*  chart.dataSource.group().length > 0? series.length = 0:null;
                  for (var i = 0, length = chart.dataSource.group().length; i < length; i++) {


                         var p =  deepcopy(copyS);
                             p.type = "column";
                             p.field = chart.dataSource.group()[i].field;
                             p.aggregate = "count";
                             p.categoryField = "monthActualShip";
                         series.push(p);
                  };
                  chart.refresh();*/
              }

        </script>

}