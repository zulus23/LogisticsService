@*
* This template takes a single argument, a String containing a
* message to display.
*@

@import com.fasterxml.jackson.databind.JsonNode
@(message: String)(implicit webJarAssets: WebJarAssets,paramReportSelectForm:Form[ParamReportSelect],select:ParamReportSelect)


@main("Точность открытия заказов") {
 @*   <div class="container-fluid">*@
        <div id="vertical">
        <div>
            <div class="col-md-offset-4 col-md-4">
                <h2 class="text-primary text-center">Точность открытия заказов</h2>
            </div>


            <div id="graph" class="col-md-offset-1 col-md-10" >
                <div class="demo-section k-content wide">
                    <div id="chart1"></div>
                </div>
            </div>
        </div>
        <div  id="t1" class="col-md-12" >
            <div id="gridTest"></div>
        </div>
        </div>
        <script>
              /* var dataall = [];

               for(order <- listOrder) {
               var order = {}
               order["OrderNumber"] = 'order.getOrderNumber()';
               order["OrderLine"] ='order.getOrderLine()';
               order["Manager"] ='order.getManager()';
               order["Customer"] ='order.getCustomer()';
               dataall.push(order);
               }
*/             $("#vertical").kendoSplitter({
                  orientation: "vertical",
                  panes: [
                      { collapsible: true, size: "60px" },
                      { collapsible: false },
                      { collapsible: false, resizable: false, size: "15%" }
                  ]
              });


               var dataSourceDB = new kendo.data.DataSource({
                   serverAggregates: true,
                   transport: {
                       read: function(options) {
                           $.ajax({
                               type: "GET",
                               url: "api/listorder",
                               contentType: "application/json; charset=utf-8",
                               dataType: 'json',
                               data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                               success: function(data) {
                                   options.success(data);
                               }
                           });
                       }
                   },
                   schema: {
                       model: {
                           id:"id",

                           fields: {
                               /* site:{type:"string"},*/
                               orderNumber: { type: "string" },
                               orderLine: { type: "number" },
                               manager: { type: "string" },
                               customer: { type: "string" },
                               itemDescription:{type:"string"},
                               monthShip:{type:"string"},
                               dateCreateOrderFormat:{type:"string"},
                               dateBeginProductionFormat:{type:"string"},
                               deviation:{type:"number"},
                               caclStatus:{type:"string"}
                           }
                       }
                   },
                   //  pageSize:20,
                   aggregate:[
                       {field:"caclStatus",aggregate:"count"},
                       {field:"customer", aggregate:"count"},
                       {field:"monthShip", aggregate:"count"}
                   ],
                   change: function(e) {
                       var data = this.data();
                           console.log(data.length); // displays "77"
                   }


               });

              var dataSourceGrapth = new kendo.data.DataSource({
                  transport: {
                      read: function(options) {
                          $.ajax({
                              type: "GET",
                              url: "api/grapth",
                              contentType: "application/json; charset=utf-8",
                              dataType: 'json',
                              data:{dateBegin: '@select.getDateBegin',dateEnd:'@select.getDateEnd', site:'@select.getEnterprise'},
                              success: function(data) {
                                  options.success(data);
                              }
                          });
                      }
                  },
                  pageSize:20
              });




              $("#gridTest").kendoGrid({
                   toolbar: ["excel"],
                   excel: {
                       allPages: true
                   },

                    dataSource: dataSourceDB
                       /* schema: {
                            model: {
                                id:"id",

                                fields: {
                                    /!* site:{type:"string"},*!/
                                    orderNumber: { type: "string" },
                                    orderLine: { type: "number" },
                                    manager: { type: "string" },
                                    customer: { type: "string" },
                                    itemDescription:{type:"string"},
                                    monthShip:{type:"string"},
                                    dateCreateOrderFormat:{type:"string"},
                                    dateBeginProductionFormat:{type:"string"},
                                    deviation:{type:"number"},
                                    caclStatus:{type:"string"}
                                }
                            }
                        }      */              ,
                    height: '100%',
                    groupable: true,

                   /*    rowTemplate: "<tr>" + "#= getGridGroupCells('gridTest') #" + "<td>...</td><td>...</td><td>...</td></tr>",
                       altRowTemplate: "<tr class='k-alt'>" +                  "#= getGridGroupCells('gridTest') #" +              "<td>...</td><td>...</td><td>...</td></tr>",*/
                    sortable: true,
                    filterable: true,
                   /* pageable: {
                         pageSizes: true
                    },*/
                    columns: [
                        { field: "orderNumber",title:"№ Заказа", width: "70px"},
                        { field: "orderLine", title: "№ Строки",  width: "30px" },
                        { field: "manager", title: "Менеджер", width: "70px" ,aggregates: ["count"],
                            groupHeaderTemplate: "Менеджер: #=value# : (#=  Math.round((count/calcAll(data,field,value))*100)#%): Count : #=count#"},
                        { field: "customer", title: "Клиент",width: "130px" ,aggregates: ["count"],
                            groupHeaderTemplate: "Клиент: #=value# : (#= Math.round((count/calcAll(data,field,value))*100)#%)"},
                        { field: "itemDescription", title: "Наименование заказа",width: "130px" },
                        { field: "monthShip", title: "Месяц отгрузки",width: "50px",aggregates: ["count"],
                                 groupHeaderTemplate: "Месяц отгрузки: #=value# : (#= calcAll(data,field,value)#)"    },
                        { field: "dateCreateOrderFormat", title: "Дата открытия заказа",width: "150px"},
                        { field: "dateBeginProductionFormat", title: "Дата начала производства",width: "150px" },
                        { field: "deviation", title: "Отклонение",width: "130px" },

                        { field: "caclStatus", title: "Состояние",width: "130px" ,aggregates: ["count"],
                                    groupHeaderTemplate: "Состояние: #=value# : (#= Math.round((count/calcAll(data,field,value))*100)#%)" }

                    ]
                });
              var level1 ,level2 ,level3 ,level4 ;
              var p = [];
              var groupLevel = 0;
              _filters_ = [];
              filterTemp ={};
              levelFilter = [];
              var allCountInGroup = 0;
              prevData=[];
              function calcAll(data,field,value){
                  resultAll = 0



                  for (var i = 0; i < dataSourceDB.group().length; i++) {


                      if (dataSourceDB.group()[i].field === field && dataSourceDB.group().length > 1 && i !== dataSourceDB.group().length-1) {
                          _filters_[i] = {field:  field,
                                       value: value,
                                       operator: "eq"};

                           //filterTemp = {filters:_filters_}
                          levelFilter[groupLevel] = {filters:_filters_}
                      }
                      if(groupLevel == 0){ levelFilter[groupLevel]={}; levelFilter[groupLevel+1]= _filters_}
                      /*if (dataSourceDB.group().length === 2) {
                          filterTemp = {
                              filters: [{
                                  field: field,
                                  value: value,
                                  operator: "eq"
                              }]
                          }
                      }*/

                  }


                  query = kendo.data.Query.process(dataSourceDB.data(), {
                      filter: levelFilter[groupLevel]
                  });
                  resultAll = query.total;
                  prevData[groupLevel] = resultAll;

                  if((prevData[groupLevel] - data.count) !== 0 && groupLevel > 0){
                      allCountInGroup = allCountInGroup + data.count;
                  } else{allCountInGroup = 0;}
                  if(allCountInGroup !== 0){
                      if(prevData[groupLevel] !== allCountInGroup) {
                          groupLevel--;
                      } else{ allCountInGroup = 0;}
                  }

                  groupLevel++;


                  /*if(dataSourceDB.group().length > 0 && allCountInGroup !== 0){ groupLevel--} else {allCountInGroup = allCountInGroup + data.count;}
                  if(predField !== field){ predField = field;}


                  if(predField === field && groupLevel > 0) {
                      allCountInGroup = allCountInGroup + data.count;
                  }else{ allCountInGroup = 0; predField =""}
*/

                  if(groupLevel > dataSourceDB.group().length - 1 && allCountInGroup === 0){ _filter_=[]; filterTemp ={}; groupLevel =0,levelFilter =[],allCountInGroup = 0;}
                  /*if(p.length === 0){
                      level1 = findObjectLevel0(level1,data)
                      level1.allCount = dataSourceDB.aggregates().caclStatus.count;
                      p.push(level1);
                  } else{
                      level1 = findObjectLevel0(p[groupLevel],data);
                      level1.allCount = countForGroup(level1);
                      p.push(level1);
                  }
                  groupLevel++;


                  if(!level1.hasSubgroups && groupLevel === 0){
                      resultAll = p[groupLevel].allCount;
                       p = [];
                       groupLevel =- 1;
                      return resultAll;
                  } else {
                      if(!level1.hasSubgroups){
                          resultAll = p[groupLevel].allCount;
                          p.length = p.length - groupLevel;  groupLevel = groupLevel-1;
                          return resultAll;
                      }

                      /!*console.log(p[groupLevel]);
                      resultAll = p[groupLevel].allCount;*!/
                      return resultAll;
                  }

                 /!* if(!level1.hasSubgroups){
                      results =dataSourceDB.aggregates().caclStatus; resultAll = results.count;
                  } else{
                      level2 = findObjectLevel0(level1,data);
                  }*!/
                  console.log(p[groupLevel]);

                  /!*for (var i = 0; i < dataView.length; i++){

                    // result =  result +selectCount(dataView[i],field,value);
                     console.log(result += loop(dataView[i]));
                  }*!/*/

                  return resultAll;
              }

              function loopData(data) {
                  console.log( " Array "+ _.isArray(data));
                  console.log( " Object "+ _.isObject(data));
                  if (data.hasSubgroups) {

                    return loopData(data.items)
                  } else{
                      return data.items
                  }
              }
               function findObjectLevel0(prev,data){
                  var dataView =  dataSourceDB.view();
                  var findObject =null;
                  for (var i = 0; i < dataView.length; i++){

                   if(dataView[i].field === data.field && dataView[i].value === data.value){
                       return dataView[i];
                   }
                   }
                   for (var i = 0; i < prev.items.length; i++){
                       if(prev.items[i].field === data.field && prev.items[i].value === data.value){

                              return prev.items[i];


                   }}

              }

              function loop(data) {
                  return data.hasSubgroups ? loop(data.items) : data.items;
              }
              function countForGroup() {
                  var tempCount = 0;
                  for (var i = 0; i < p[groupLevel].items.length; i++) {
                      tempCount = tempCount + p[groupLevel].items[i].items.length;
                  }
                  return tempCount;
              }


              $("#chart1").kendoChart({
                  dataSource: dataSourceGrapth,
                  series: [{


                      field: "series"

                  }],
                  categoryAxis: {
                      field: "categoryAxis"
                  }
              });


        </script>

}